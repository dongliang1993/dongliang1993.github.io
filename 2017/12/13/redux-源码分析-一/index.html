<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>redux 源码分析 (一) | 我是你豆子欧巴</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">redux 源码分析 (一)</h1><a id="logo" href="/.">我是你豆子欧巴</a><p class="description">我是你豆子欧巴</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">redux 源码分析 (一)</h1><div class="post-meta">Dec 13, 2017</div><div class="post-content"><h2 id="index-js-文件"><a href="#index-js-文件" class="headerlink" title="index.js 文件"></a>index.js 文件</h2><p>我们先大体看一下这个这个文件的输入和输出：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">createStore</span>(<span class="params">reducer, preloadedState, enhancer</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    dispatch,</div><div class="line">    subscribe,</div><div class="line">    getState,</div><div class="line">    replaceReducer,</div><div class="line">    [$$observable]: observable</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>createStore 函数接受三个参数：reducer，preloadedState，enhancer。分别对应全局 reducer，store 中初始的 state 和 applyMiddleware 中间件函数。只有第一个参数是必传的，后面两个参数可选。返回值是一个对象，一共暴露出来了五个方法，但是我们常用的一般只有前三个</p>
<p>我们使用 createStore 创建 store 时，一般有三种用法<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 第一种用法</span></div><div class="line"><span class="comment">// 只有一个reducer</span></div><div class="line"><span class="keyword">const</span> store = createStore(</div><div class="line">  reducer,</div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// 第二种用法</span></div><div class="line"><span class="comment">// 传入一个 initState</span></div><div class="line"><span class="keyword">const</span> store = createStore(</div><div class="line">  reducer,</div><div class="line">  initState,</div><div class="line">)</div><div class="line"><span class="comment">// 传入一个 enhancer</span></div><div class="line"><span class="keyword">const</span> store = createStore(</div><div class="line">  reducer,</div><div class="line">  applyMiddleware(...middleware),</div><div class="line">)</div><div class="line"></div><div class="line"><span class="comment">// 第三种用法</span></div><div class="line"><span class="keyword">const</span> store = createStore(</div><div class="line">  reducer,</div><div class="line">  initState,</div><div class="line">  applyMiddleware(...middleware),</div><div class="line">)</div></pre></td></tr></table></figure></p>
<p>Store 有以下职责：</p>
<ol>
<li>维持应用的 state；</li>
<li>提供 getState() 方法获取 state；</li>
<li>提供 dispatch(action) 方法更新 state；</li>
<li>通过 subscribe(listener) 注册监听器;</li>
<li>通过 subscribe(listener) 返回的函数注销监听器。</li>
</ol>
<p>分别对应 store 身上暴露出来的几个函数</p>
<p>大致的功能说完了，接下来让我们看一下源码是怎么实现的：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 调整参数</span></div><div class="line"><span class="comment">// 处理的第二种用法中的情况二： 传入一个 reducer 和 一个 enhancer</span></div><div class="line"><span class="comment">// 没有传入预先加载的state</span></div><div class="line"><span class="comment">// 并且第二个参数是一个函数的话，则把第二个参数为功能增强函数enhancer</span></div><div class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> preloadedState === <span class="string">'function'</span> &amp;&amp; <span class="keyword">typeof</span> enhancer === <span class="string">'undefined'</span>) &#123;</div><div class="line">  enhancer = preloadedState</div><div class="line">  preloadedState = <span class="literal">undefined</span></div><div class="line">&#125;</div><div class="line"><span class="comment">// 如果有 enhancer 的话，要对 enhancer 进行处理</span></div><div class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> enhancer !== <span class="string">'undefined'</span>) &#123;</div><div class="line">  <span class="comment">// 判断 enhancer 必须是一个函数</span></div><div class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> enhancer !== <span class="string">'function'</span>) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Expected the enhancer to be a function.'</span>)</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 这是一个很重要的处理，它将 createStore 方法作为参数传入enhancer函数，</span></div><div class="line">  <span class="comment">// 并且执行enhancer</span></div><div class="line">  <span class="comment">// 这里主要是提供给redux中间件的使用，以此来达到增强整个redux流程的效果</span></div><div class="line">  <span class="comment">// 通过这个函数，也给redux提供了无限多的可能性</span></div><div class="line">  <span class="keyword">return</span> enhancer(createStore)(reducer, preloadedState)</div><div class="line">&#125;</div><div class="line"><span class="comment">// reducer必须是一个函数，否则报错</span></div><div class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> reducer !== <span class="string">'function'</span>) &#123;</div><div class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Expected the reducer to be a function.'</span>)</div><div class="line">&#125;</div><div class="line"><span class="comment">// 将传入的reducer缓存到currentReducer变量中</span></div><div class="line"><span class="keyword">let</span> currentReducer = reducer</div><div class="line"><span class="comment">// 将传入的preloadedState缓存到currentState变量中</span></div><div class="line"><span class="keyword">let</span> currentState = preloadedState</div><div class="line"><span class="comment">// 定义当前的监听者队列</span></div><div class="line"><span class="keyword">let</span> currentListeners = []</div><div class="line"><span class="comment">// 定义下一个循环的监听者队列</span></div><div class="line"><span class="keyword">let</span> nextListeners = currentListeners</div><div class="line"><span class="comment">// 定义一个判断是否在dispatch的标志位</span></div><div class="line"><span class="keyword">let</span> isDispatching = <span class="literal">false</span></div><div class="line"><span class="comment">// 判断是否能执行下一次监听队列</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">ensureCanMutateNextListeners</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (nextListeners === currentListeners) &#123;</div><div class="line">    <span class="comment">// 这里是将当前监听队列通过拷贝的形式赋值给下次监听队列，这样做是为了防止在当前队列执行的时候会影响到自身，所以拷贝了一份副本</span></div><div class="line">    nextListeners = currentListeners.slice()</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们后面分析道 enhancer 源码的时候，会对这部分再详细的讲解</p>
<p>接着往下看<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"></div><div class="line"><span class="comment">// When a store is created, an "INIT" action is dispatched so that every</span></div><div class="line"><span class="comment">// reducer returns their initial state. This effectively populates</span></div><div class="line"><span class="comment">// the initial state tree.</span></div><div class="line"><span class="comment">// 当 store 被创建的时候， 派发了一个 "INIT" 的 action，所以每个 reducer 都被执行，</span></div><div class="line"><span class="comment">// 然后 return 出他们的初始值，这些初始值生成了初始的 state tree</span></div><div class="line"><span class="comment">// dispatch一个初始化的action</span></div><div class="line">dispatch(&#123; <span class="attr">type</span>: ActionTypes.INIT &#125;)</div></pre></td></tr></table></figure></p>
<p>这里可以看到，在我们创建 store 的时候，就已经执行了第一次的<br>dispatch ，一个 “INIT” action 已经被派发出去了，挨个执行了<br>所有的reducer。这个的作用书要是用来初始化 state 树。这也是为什么我们即使没有传入 initState 也可以拥有初始化 state 的原因</p>
<p>接下来我们理所应当的进入到 dispatch 函数来一探究竟<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment">  * Dispatches an action. It is the only way to trigger a state change.</span></div><div class="line"><span class="comment">  * The `reducer` function, used to create the store, will be called with the</span></div><div class="line"><span class="comment">  * current state tree and the given `action`. Its return value will</span></div><div class="line"><span class="comment">  * be considered the **next** state of the tree, and the change listeners</span></div><div class="line"><span class="comment">  * will be notified.</span></div><div class="line"><span class="comment">  * </span></div><div class="line"><span class="comment">  * 派发一个 action ，这是触发 state 改变的唯一方式</span></div><div class="line"><span class="comment">  * 被用来创建一个 store 的 reducer 函数，会被一个 action 来触发调用</span></div><div class="line"><span class="comment">  * 这个 reducer 的返回值就是下一次 state 的值，并且 listeners 也会被通知调用</span></div><div class="line"><span class="comment">  * </span></div><div class="line"><span class="comment">  * The base implementation only supports plain object actions. If you want to</span></div><div class="line"><span class="comment">  * dispatch a Promise, an Observable, a thunk, or something else, you need to</span></div><div class="line"><span class="comment">  * wrap your store creating function into the corresponding middleware. For</span></div><div class="line"><span class="comment">  * example, see the documentation for the `redux-thunk` package. Even the</span></div><div class="line"><span class="comment">  * middleware will eventually dispatch plain object actions using this method.</span></div><div class="line"><span class="comment">  *</span></div><div class="line"><span class="comment">  * 这个最基本的实现只支持扁平化的 actions，如果你想派发一个 promise、Observable、thunk</span></div><div class="line"><span class="comment">  * 或者其他东西，你需要用中间件包装你的 createStore 函数</span></div><div class="line"><span class="comment">  * 即使被中间件包装，最后还是派发了一个扁平的 action</span></div><div class="line"><span class="comment">  * </span></div><div class="line"><span class="comment">  * @param &#123;Object&#125; action A plain object representing “what changed”. It is</span></div><div class="line"><span class="comment">  * a good idea to keep actions serializable so you can record and replay user</span></div><div class="line"><span class="comment">  * sessions, or use the time travelling `redux-devtools`. An action must have</span></div><div class="line"><span class="comment">  * a `type` property which may not be `undefined`. It is a good idea to use</span></div><div class="line"><span class="comment">  * string constants for action types.</span></div><div class="line"><span class="comment">  *</span></div><div class="line"><span class="comment">  * @returns &#123;Object&#125; For convenience, the same action object you dispatched.</span></div><div class="line"><span class="comment">  *</span></div><div class="line"><span class="comment">  * Note that, if you use a custom middleware, it may wrap `dispatch()` to</span></div><div class="line"><span class="comment">  * return something else (for example, a Promise you can await).</span></div><div class="line"><span class="comment">  */</span></div><div class="line"> <span class="comment">// redux 中通过 dispatch 一个 action ，来触发对 store 中的 state 的修改</span></div><div class="line"> <span class="comment">// 参数就是一个 action</span></div><div class="line"> <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">action</span>) </span>&#123;</div><div class="line">   <span class="comment">// 这里判断一下 action 是否是一个扁平的对象，如果不是则抛出错误</span></div><div class="line">   <span class="keyword">if</span> (!isPlainObject(action)) &#123;</div><div class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</div><div class="line">       <span class="string">'Actions must be plain objects. '</span> +</div><div class="line">         <span class="string">'Use custom middleware for async actions.'</span></div><div class="line">     )</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// action中必须要有type属性，否则抛出错误</span></div><div class="line">   <span class="keyword">if</span> (<span class="keyword">typeof</span> action.type === <span class="string">'undefined'</span>) &#123;</div><div class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</div><div class="line">       <span class="string">'Actions may not have an undefined "type" property. '</span> +</div><div class="line">         <span class="string">'Have you misspelled a constant?'</span></div><div class="line">     )</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// 如果上一次dispatch还没结束，则不能继续dispatch下一次</span></div><div class="line">   <span class="keyword">if</span> (isDispatching) &#123;</div><div class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Reducers may not dispatch actions.'</span>)</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">     <span class="comment">// 将isDispatching设置为true，表示当次dispatch开始</span></div><div class="line">     isDispatching = <span class="literal">true</span></div><div class="line">     <span class="comment">// 利用传入的reducer函数处理state和action，返回新的state</span></div><div class="line">     <span class="comment">// 推荐不直接修改原有的currentState</span></div><div class="line">     currentState = currentReducer(currentState, action)</div><div class="line">   &#125; <span class="keyword">finally</span> &#123;</div><div class="line">     <span class="comment">// 当次的dispatch结束</span></div><div class="line">     isDispatching = <span class="literal">false</span></div><div class="line">   &#125;</div><div class="line">   <span class="comment">// 每次dispatch结束之后，就执行监听队列中的监听函数</span></div><div class="line">   <span class="comment">// 将nextListeners赋值给currentListeners，保证下一次执行ensureCanMutateNextListeners方法的时候会重新拷贝一个新的副本</span></div><div class="line">   <span class="comment">// 简单粗暴的使用for循环执行</span></div><div class="line">   <span class="keyword">const</span> listeners = (currentListeners = nextListeners)</div><div class="line">   <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; listeners.length; i++) &#123;</div><div class="line">     <span class="keyword">const</span> listener = listeners[i]</div><div class="line">     listener()</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// 最后返回action</span></div><div class="line">   <span class="keyword">return</span> action</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>然后是 getState 函数<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Reads the state tree managed by the store.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @returns &#123;any&#125; The current state tree of your application.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment">// 获取当前的state</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">getState</span>(<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (isDispatching) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</div><div class="line">      <span class="string">'You may not call store.getState() while the reducer is executing. '</span> +</div><div class="line">        <span class="string">'The reducer has already received the state as an argument. '</span> +</div><div class="line">        <span class="string">'Pass it down from the top reducer instead of reading it from the store.'</span></div><div class="line">    )</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> currentState</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>subscribe 函数<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Adds a change listener. It will be called any time an action is dispatched,</span></div><div class="line"><span class="comment"> * and some part of the state tree may potentially have changed. You may then</span></div><div class="line"><span class="comment"> * call `getState()` to read the current state tree inside the callback.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * 添加一个事件监听。每次派发一个 action 或者 state 树发生变化都会依次执行</span></div><div class="line"><span class="comment"> * listener 里面的所有监听函数</span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> * You may call `dispatch()` from a change listener, with the following</span></div><div class="line"><span class="comment"> * caveats:</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * 1. The subscriptions are snapshotted just before every `dispatch()` call.</span></div><div class="line"><span class="comment"> * If you subscribe or unsubscribe while the listeners are being invoked, this</span></div><div class="line"><span class="comment"> * will not have any effect on the `dispatch()` that is currently in progress.</span></div><div class="line"><span class="comment"> * However, the next `dispatch()` call, whether nested or not, will use a more</span></div><div class="line"><span class="comment"> * recent snapshot of the subscription list.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * 2. The listener should not expect to see all state changes, as the state</span></div><div class="line"><span class="comment"> * might have been updated multiple times during a nested `dispatch()` before</span></div><div class="line"><span class="comment"> * the listener is called. It is, however, guaranteed that all subscribers</span></div><div class="line"><span class="comment"> * registered before the `dispatch()` started will be called with the latest</span></div><div class="line"><span class="comment"> * state by the time it exits.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param &#123;Function&#125; listener A callback to be invoked on every dispatch.</span></div><div class="line"><span class="comment"> * @returns &#123;Function&#125; A function to remove this change listener.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment">// 往监听队列里面去添加监听者</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">subscribe</span>(<span class="params">listener</span>) </span>&#123;</div><div class="line">  <span class="comment">// 监听者必须是一个函数</span></div><div class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> listener !== <span class="string">'function'</span>) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Expected listener to be a function.'</span>)</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 如果正在 isDispatching</span></div><div class="line">  <span class="keyword">if</span> (isDispatching) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</div><div class="line">      <span class="string">'You may not call store.subscribe() while the reducer is executing. '</span> +</div><div class="line">        <span class="string">'If you would like to be notified after the store has been updated, subscribe from a '</span> +</div><div class="line">        <span class="string">'component and invoke store.getState() in the callback to access the latest state. '</span> +</div><div class="line">        <span class="string">'See http://redux.js.org/docs/api/Store.html#subscribe for more details.'</span></div><div class="line">    )</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 声明一个变量来标记是否已经subscribed，通过闭包的形式被缓存</span></div><div class="line">  <span class="keyword">let</span> isSubscribed = <span class="literal">true</span></div><div class="line">  <span class="comment">// 创建一个当前currentListeners的副本，赋值给nextListeners</span></div><div class="line">  ensureCanMutateNextListeners()</div><div class="line">  <span class="comment">// 将监听者函数push到nextListeners中</span></div><div class="line">  nextListeners.push(listener)</div><div class="line">  <span class="comment">// 返回一个取消监听的函数</span></div><div class="line">  <span class="comment">// 原理很简单就是从将当前函数从数组中删除，使用的是数组的splice方法</span></div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">unsubscribe</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!isSubscribed) &#123;</div><div class="line">      <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (isDispatching) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</div><div class="line">        <span class="string">'You may not unsubscribe from a store listener while the reducer is executing. '</span> +</div><div class="line">          <span class="string">'See http://redux.js.org/docs/api/Store.html#subscribe for more details.'</span></div><div class="line">      )</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    isSubscribed = <span class="literal">false</span></div><div class="line"></div><div class="line">    ensureCanMutateNextListeners()</div><div class="line">    <span class="keyword">const</span> index = nextListeners.indexOf(listener)</div><div class="line">    nextListeners.splice(index, <span class="number">1</span>)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Replaces the reducer currently used by the store to calculate the state.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * You might need this if your app implements code splitting and you want to</span></div><div class="line"><span class="comment"> * load some of the reducers dynamically. You might also need this if you</span></div><div class="line"><span class="comment"> * implement a hot reloading mechanism for Redux.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param &#123;Function&#125; nextReducer The reducer for the store to use instead.</span></div><div class="line"><span class="comment"> * @returns &#123;void&#125;</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment">// replaceReducer方法，顾名思义就是替换当前的reducer处理函数</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">replaceReducer</span>(<span class="params">nextReducer</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> nextReducer !== <span class="string">'function'</span>) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Expected the nextReducer to be a function.'</span>)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  currentReducer = nextReducer</div><div class="line">  dispatch(&#123; <span class="attr">type</span>: ActionTypes.REPLACE &#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="combineReducers-js"><a href="#combineReducers-js" class="headerlink" title="combineReducers.js"></a>combineReducers.js</h2><p>首先看一下整体<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">combineReducers</span>(<span class="params">reducers</span>) </span>&#123;</div><div class="line">  ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看到，这个文件就单独的导出了 combineReducers 这一个函数</p>
<p>combineReducers 只接受一个对象作为参数, 我们通常这么使用<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">const</span> todoApp = combineReducers(&#123;</div><div class="line">  visibilityFilter,</div><div class="line">  todos</div><div class="line">&#125;)</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">todoApp</span>(<span class="params">state = &#123;&#125;, action</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    visibilityFilter: visibilityFilter(state.visibilityFilter, action),</div><div class="line">    todos: todos(state.todos, action)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这两种写法是一样的</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Turns an object whose values are different reducer functions, into a single</span></div><div class="line"><span class="comment"> * reducer function. It will call every child reducer, and gather their results</span></div><div class="line"><span class="comment"> * into a single state object, whose keys correspond to the keys of the passed</span></div><div class="line"><span class="comment"> * reducer functions.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * 把一个对象转换成单个的 reducer 函数，这个对象的 value 是拆分出来的单个reducer。combineReducers 函数会调用所有的 reducer，然后把返回值收集起来</span></div><div class="line"><span class="comment"> * 组成一个单个的 state object，key 值与 参数中 reducer functions 的key</span></div><div class="line"><span class="comment"> * 值一一对应</span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> * @param &#123;Object&#125; reducers An object whose values correspond to different</span></div><div class="line"><span class="comment"> * reducer functions that need to be combined into one. One handy way to obtain</span></div><div class="line"><span class="comment"> * it is to use ES6 `import * as reducers` syntax. The reducers may never return</span></div><div class="line"><span class="comment"> * undefined for any action. Instead, they should return their initial state</span></div><div class="line"><span class="comment"> * if the state passed to them was undefined, and the current state for any</span></div><div class="line"><span class="comment"> * unrecognized action.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @returns &#123;Function&#125; A reducer function that invokes every reducer inside the</span></div><div class="line"><span class="comment"> * passed object, and builds a state object with the same shape.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment">// 导出combineReducers方法，接受一个参数reducers对象</span></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">combineReducers</span>(<span class="params">reducers</span>) </span>&#123;</div><div class="line">  <span class="comment">// 获取reducers对象的key值</span></div><div class="line">  <span class="keyword">const</span> reducerKeys = <span class="built_in">Object</span>.keys(reducers)</div><div class="line">  <span class="comment">// 定义一个最终要返回的 reducers 对象</span></div><div class="line">  <span class="keyword">const</span> finalReducers = &#123;&#125;</div><div class="line">  <span class="comment">// 遍历这个reducers对象的key</span></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; reducerKeys.length; i++) &#123;</div><div class="line">    <span class="comment">// 缓存每个key值</span></div><div class="line">    <span class="keyword">const</span> key = reducerKeys[i]</div><div class="line">    <span class="comment">// 如果不是生产环境</span></div><div class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> reducers[key] === <span class="string">'undefined'</span>) &#123;</div><div class="line">        warning(<span class="string">`No reducer provided for key "<span class="subst">$&#123;key&#125;</span>"`</span>)</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 相应key的值是个函数，则将改函数缓存到finalReducers中</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> reducers[key] === <span class="string">'function'</span>) &#123;</div><div class="line">      finalReducers[key] = reducers[key]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 上面那一步其实主要是起到过滤作用</span></div><div class="line">  <span class="comment">// 把 reducers 中 key-val 对中 value 不是函数的过滤掉了</span></div><div class="line"></div><div class="line">  <span class="comment">// 获取finalReducers的所有的key值，缓存到变量finalReducerKeys中</span></div><div class="line">  <span class="keyword">const</span> finalReducerKeys = <span class="built_in">Object</span>.keys(finalReducers)</div><div class="line"></div><div class="line">  <span class="keyword">let</span> unexpectedKeyCache</div><div class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</div><div class="line">    unexpectedKeyCache = &#123;&#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// 定义一个变量，用于缓存错误对象</span></div><div class="line">  <span class="keyword">let</span> shapeAssertionError</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    <span class="comment">// 做错误处理，详情看后面assertReducerShape方法</span></div><div class="line">    <span class="comment">// 主要就是检测，</span></div><div class="line">    assertReducerShape(finalReducers)</div><div class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</div><div class="line">    shapeAssertionError = e</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// combineReducers 调用后还是会返回一个函数</span></div><div class="line">  <span class="comment">// 这样就和 createStore 中的参数对应上了</span></div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">combination</span>(<span class="params">state = &#123;&#125;, action</span>) </span>&#123;</div><div class="line">    <span class="comment">// 如果有错误，则抛出错误</span></div><div class="line">    <span class="keyword">if</span> (shapeAssertionError) &#123;</div><div class="line">      <span class="keyword">throw</span> shapeAssertionError</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</div><div class="line">      <span class="comment">// 获取警告提示</span></div><div class="line">      <span class="keyword">const</span> warningMessage = getUnexpectedStateShapeWarningMessage(</div><div class="line">        state,</div><div class="line">        finalReducers,</div><div class="line">        action,</div><div class="line">        unexpectedKeyCache</div><div class="line">      )</div><div class="line">      <span class="keyword">if</span> (warningMessage) &#123;</div><div class="line">        warning(warningMessage)</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 定义一个变量来表示state是否已经被改变</span></div><div class="line">    <span class="keyword">let</span> hasChanged = <span class="literal">false</span></div><div class="line">    <span class="comment">// 定义一个变量，来缓存改变后的state</span></div><div class="line">    <span class="keyword">const</span> nextState = &#123;&#125;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; finalReducerKeys.length; i++) &#123;</div><div class="line">      <span class="comment">// 获取有效的reducer的key值</span></div><div class="line">      <span class="keyword">const</span> key = finalReducerKeys[i]</div><div class="line">      <span class="comment">// 根据key值获取对应的reducer函数</span></div><div class="line">      <span class="keyword">const</span> reducer = finalReducers[key]</div><div class="line">      <span class="comment">// 根据 key 值获取每个 reducer 对应的 state 的部分</span></div><div class="line">      <span class="keyword">const</span> previousStateForKey = state[key]</div><div class="line">      <span class="comment">// 执行 reducer 函数，获取相应模块的state</span></div><div class="line">      <span class="keyword">const</span> nextStateForKey = reducer(previousStateForKey, action)</div><div class="line">      <span class="comment">// 如果获取的state是undefined,则抛出错误</span></div><div class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> nextStateForKey === <span class="string">'undefined'</span>) &#123;</div><div class="line">        <span class="keyword">const</span> errorMessage = getUndefinedStateErrorMessage(key, action)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(errorMessage)</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// 将获取到的新的state赋值给新的state对应的模块，</span></div><div class="line">      <span class="comment">// key则为当前reducer的key</span></div><div class="line">      nextState[key] = nextStateForKey</div><div class="line">      <span class="comment">// 判读state是否发生改变</span></div><div class="line">      hasChanged = hasChanged || nextStateForKey !== previousStateForKey</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 如果state发生改变则返回新的state，否则返回原来的state</span></div><div class="line">    <span class="keyword">return</span> hasChanged ? nextState : state</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="bindActionCreators-js"><a href="#bindActionCreators-js" class="headerlink" title="bindActionCreators.js"></a>bindActionCreators.js</h2><p>首先先认识 actionCreators, 简单来说就是创建 action 的方法，redux 的 action 是一个对象，而我们经常使用一些函数来创建这些对象，则这些函数就是 actionCreators</p>
<p>而这个文件实现的功能，是根据绑定的 actionCreator，来实现自动dispatch的功能</p>
<p>actionCreators 接受两个参数，第一个参数是个对象，第二个参数是 dispatch<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// actionCreators</span></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">addTodo</span>(<span class="params">text</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    type: <span class="string">'ADD_TODO'</span>,</div><div class="line">    text</div><div class="line">  &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">removeTodo</span>(<span class="params">id</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    type: <span class="string">'REMOVE_TODO'</span>,</div><div class="line">    id</div><div class="line">  &#125;;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>第一个参数的格式<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  addTodo: <span class="function"><span class="keyword">function</span> <span class="title">addTodo</span>(<span class="params">text</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">      type: <span class="string">'ADD_TODO'</span>,</div><div class="line">      text</div><div class="line">    &#125;;</div><div class="line">  &#125;,</div><div class="line">  removeTodo: <span class="function"><span class="keyword">function</span> <span class="title">removeTodo</span>(<span class="params">id</span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">      type: <span class="string">'REMOVE_TODO'</span>,</div><div class="line">      id</div><div class="line">    &#125;;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>用法：<br>boundActionCreators..addTodo(‘Use Redux’)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindActionCreator</span>(<span class="params">actionCreator, dispatch</span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">return</span> dispatch(actionCreator.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>))</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Turns an object whose values are action creators, into an object with the</span></div><div class="line"><span class="comment"> * same keys, but with every function wrapped into a `dispatch` call so they</span></div><div class="line"><span class="comment"> * may be invoked directly. This is just a convenience method, as you can call</span></div><div class="line"><span class="comment"> * `store.dispatch(MyActionCreators.doSomething())` yourself just fine.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * For convenience, you can also pass a single function as the first argument,</span></div><div class="line"><span class="comment"> * and get a function in return.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param &#123;Function|Object&#125; actionCreators An object whose values are action</span></div><div class="line"><span class="comment"> * creator functions. One handy way to obtain it is to use ES6 `import * as`</span></div><div class="line"><span class="comment"> * syntax. You may also pass a single function.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @param &#123;Function&#125; dispatch The `dispatch` function available on your Redux</span></div><div class="line"><span class="comment"> * store.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @returns &#123;Function|Object&#125; The object mimicking the original object, but with</span></div><div class="line"><span class="comment"> * every action creator wrapped into the `dispatch` call. If you passed a</span></div><div class="line"><span class="comment"> * function as `actionCreators`, the return value will also be a single</span></div><div class="line"><span class="comment"> * function.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="comment">// 对外暴露这个bindActionCreators方法</span></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">bindActionCreators</span>(<span class="params">actionCreators, dispatch</span>) </span>&#123;</div><div class="line">  <span class="comment">// 如果传入的actionCreators参数是个函数，则直接调用bindActionCreator方法</span></div><div class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> actionCreators === <span class="string">'function'</span>) &#123;</div><div class="line">    <span class="keyword">return</span> bindActionCreator(actionCreators, dispatch)</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 错误处理</span></div><div class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> actionCreators !== <span class="string">'object'</span> || actionCreators === <span class="literal">null</span>) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</div><div class="line">      <span class="string">`bindActionCreators expected an object or a function, instead received <span class="subst">$&#123;</span></span></div><div class="line"><span class="string"><span class="subst">        actionCreators === <span class="literal">null</span> ? <span class="string">'null'</span> : <span class="keyword">typeof</span> actionCreators</span></span></div><div class="line"><span class="string"><span class="subst">      &#125;</span>. `</span> +</div><div class="line">        <span class="string">`Did you write "import ActionCreators from" instead of "import * as ActionCreators from"?`</span></div><div class="line">    )</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 如果actionCreators是一个对象，则获取对象中的key</span></div><div class="line">  <span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(actionCreators)</div><div class="line">  <span class="comment">// 定义一个缓存对象</span></div><div class="line">  <span class="keyword">const</span> boundActionCreators = &#123;&#125;</div><div class="line">  <span class="comment">// 遍历actionCreators的每个key</span></div><div class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; keys.length; i++) &#123;</div><div class="line">    <span class="comment">// 获取每个key</span></div><div class="line">    <span class="keyword">const</span> key = keys[i]</div><div class="line">    <span class="comment">// 根据每个key获取特定的actionCreator方法</span></div><div class="line">    <span class="keyword">const</span> actionCreator = actionCreators[key]</div><div class="line">    <span class="comment">// 如果actionCreator是一个函数，则直接调用bindActionCreator方法，将返回的匿名函数缓存到boundActionCreators对象中</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> actionCreator === <span class="string">'function'</span>) &#123;</div><div class="line">      boundActionCreators[key] = bindActionCreator(actionCreator, dispatch)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 最后返回boundActionCreators对象</span></div><div class="line">  <span class="comment">// 用户获取到这个对象后，可拿出对象中的每个key的对应的值，也就是各个匿名函数，执行匿名函数就可以实现dispatch功能</span></div><div class="line">  <span class="keyword">return</span> boundActionCreators</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="compose"><a href="#compose" class="headerlink" title="compose"></a>compose</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">compose(</div><div class="line">  applyMiddleware(thunk),</div><div class="line">  DevTools.instrument()</div><div class="line">)</div></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Composes single-argument functions from right to left. The rightmost</span></div><div class="line"><span class="comment"> * function can take multiple arguments as it provides the signature for</span></div><div class="line"><span class="comment"> * the resulting composite function.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * 合成多个只接受一个参数的函数，它的返回值将作为一个参数提供给它左边的函数，</span></div><div class="line"><span class="comment"> * 以此类推。例外是最右边的参数可以接受多个参数，因为它将为由此产生的函数提供签名。</span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> * （译者注：compose(funcA, funcB, funcC) 形象为 compose(funcA(funcB(funcC())))）</span></div><div class="line"><span class="comment"> * </span></div><div class="line"><span class="comment"> * @param &#123;...Function&#125; funcs The functions to compose.</span></div><div class="line"><span class="comment"> * @returns &#123;Function&#125; A function obtained by composing the argument functions</span></div><div class="line"><span class="comment"> * from right to left. For example, compose(f, g, h) is identical to doing</span></div><div class="line"><span class="comment"> * (...args) =&gt; f(g(h(...args))).</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">compose</span>(<span class="params">...funcs</span>) </span>&#123;</div><div class="line">  <span class="comment">// 判断函数数组是否为空</span></div><div class="line">  <span class="keyword">if</span> (funcs.length === <span class="number">0</span>) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="params">arg</span> =&gt;</span> arg</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 如果函数数组只有一个元素，则直接执行</span></div><div class="line">  <span class="keyword">if</span> (funcs.length === <span class="number">1</span>) &#123;</div><div class="line">    <span class="keyword">return</span> funcs[<span class="number">0</span>]</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 否则，就利用reduce方法执行每个中间件函数，并将上一个函数的返回作为下一个函数的参数</span></div><div class="line">  <span class="keyword">return</span> funcs.reduce(<span class="function">(<span class="params">a, b</span>) =&gt;</span> (...args) =&gt; a(b(...args)))</div><div class="line">&#125;</div></pre></td></tr></table></figure></div><div class="tags"></div><div class="post-nav"><a href="/2017/12/12/深入ES6-09-JS-的类/" class="next">深入ES6 09-JS 的类</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/12/13/redux-源码分析-一/">redux 源码分析 (一)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/12/深入ES6-09-JS-的类/">深入ES6 09-JS 的类</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/12/深入ES6-07-Set与Map/">深入ES6 07-Set与Map</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/12/深入ES6-06-符号与符号属性/">深入ES6 06-符号与符号属性</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/12/深入-ES6-04-扩展的对象功能/">深入-ES6-04 扩展的对象功能</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/07/函数式编程笔记（一）/">函数式编程笔记（一）</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/07/koa2-源码分析之-request-js/">koa2 源码分析之 request.js</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/06/koa2-源码分析-一/">koa2 源码分析 (一)</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/04/babel从入门到入门的知识归纳/">babel从入门到入门的知识归纳</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/04/react-代码规范/">react 代码规范</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2017 <a href="/." rel="nofollow">我是你豆子欧巴.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.1.20/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>